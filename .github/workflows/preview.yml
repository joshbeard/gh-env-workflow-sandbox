name: "GitHub Actions Workflow Test"

permissions:
  contents: read
  issues: write
  pull-requests: write

on:
  pull_request:
    types: [closed]  # Only for cleanup
  issue_comment:
    types: [created]  # For /demo commands
  workflow_dispatch:  # Manual triggers
    inputs:
      pr_number:
        description: 'PR number for manual test'
        required: false
        type: string
      custom_args:
        description: 'Custom arguments to test'
        required: false
        type: string

jobs:
  security-check:
    name: "Parse Comment & Security Check"
    runs-on: ubuntu-latest
    if: github.event_name == 'issue_comment' &&
        github.event.issue.pull_request != null &&
        startsWith(github.event.comment.body, '/demo')
    environment: preview-pr
    outputs:
      should_run: ${{ steps.parse.outputs.should_run }}
      custom_args: ${{ steps.parse.outputs.custom_args }}
      pr_number: ${{ steps.parse.outputs.pr_number }}
      cleanup_only: ${{ steps.parse.outputs.cleanup_only }}
      pr_head_sha: ${{ steps.get-pr.outputs.pr_head_sha }}

    steps:
      - name: Get PR details
        id: get-pr
        uses: actions/github-script@v6
        with:
          script: |
            const pr = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: ${{ github.event.issue.number }}
            });

            console.log(`PR #${pr.data.number}: ${pr.data.title}`);
            console.log(`Head SHA: ${pr.data.head.sha}`);
            console.log(`Base: ${pr.data.base.ref} -> Head: ${pr.data.head.ref}`);

            return {
              pr_head_sha: pr.data.head.sha,
              pr_head_ref: pr.data.head.ref
            };

      - name: Parse comment and check permissions
        id: parse
        env:
          COMMENT_BODY: ${{ github.event.comment.body }}
          COMMENT_USER: ${{ github.event.comment.user.login }}
          COMMENT_AUTH: ${{ github.event.comment.author_association }}
          PR_NUMBER: ${{ github.event.issue.number }}
        run: |
          echo "üîç Comment: $COMMENT_BODY"
          echo "üë§ User: $COMMENT_USER"
          echo "üè∑Ô∏è  Permission: $COMMENT_AUTH"
          echo "üìã PR: $PR_NUMBER"
          echo "üîó Head SHA: ${{ fromJson(steps.get-pr.outputs.result).pr_head_sha }}"
          echo ""

          # Parse command safely using environment variable
          should_run="false"
          cleanup_only="false"
          custom_args=""

          if [[ "$COMMENT_BODY" == "/demo" ]]; then
            echo "‚úÖ Basic test command"
            should_run="true"
          elif [[ "$COMMENT_BODY" == "/demo cleanup" ]]; then
            echo "üßπ Cleanup command"
            cleanup_only="true"
          elif [[ "$COMMENT_BODY" =~ ^/demo[[:space:]].+ ]]; then
            echo "‚öôÔ∏è  Custom command with args"
            should_run="true"
            # Safely extract args using parameter expansion
            custom_args="${COMMENT_BODY#/demo }"
            # Remove leading whitespace
            custom_args="${custom_args#"${custom_args%%[![:space:]]*}"}"
            echo "üìù Args: $custom_args"
          else
            echo "‚ùå Unrecognized command"
          fi

          # Check permissions
          if [[ "$COMMENT_AUTH" == "COLLABORATOR" || "$COMMENT_AUTH" == "MEMBER" || "$COMMENT_AUTH" == "OWNER" ]]; then
            echo "‚úÖ User authorized"
          else
            echo "üö´ User not authorized"
            should_run="false"
            cleanup_only="false"
          fi

          # Set outputs
          echo "should_run=$should_run" >> $GITHUB_OUTPUT
          echo "custom_args=$custom_args" >> $GITHUB_OUTPUT
          echo "pr_number=$PR_NUMBER" >> $GITHUB_OUTPUT
          echo "cleanup_only=$cleanup_only" >> $GITHUB_OUTPUT
          echo "pr_head_sha=${{ fromJson(steps.get-pr.outputs.result).pr_head_sha }}" >> $GITHUB_OUTPUT

  test-workflow:
    name: "Test Workflow Mechanisms"
    runs-on: ubuntu-latest
    needs: security-check
    if: needs.security-check.outputs.should_run == 'true'
    environment: preview-pr

    env:
      CUSTOM_ARGS: ${{ needs.security-check.outputs.custom_args }}
      PR_NUMBER: ${{ needs.security-check.outputs.pr_number }}
      PR_HEAD_SHA: ${{ needs.security-check.outputs.pr_head_sha }}

    steps:
      - name: Create pending status check
        uses: actions/github-script@v6
        with:
          script: |
            await github.rest.repos.createCommitStatus({
              owner: context.repo.owner,
              repo: context.repo.repo,
              sha: '${{ env.PR_HEAD_SHA }}',
              state: 'pending',
              context: 'Preview Demo Test',
              description: 'Running workflow test...',
              target_url: `https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}`
            });

      - name: Checkout
        uses: actions/checkout@v4

      - name: Show context
        run: |
          echo "üåç Workflow Context:"
          echo "  Event: ${{ github.event_name }}"
          echo "  Repository: ${{ github.repository }}"
          echo "  Actor: ${{ github.actor }}"
          echo "  SHA: ${{ github.sha }}"
          echo "  PR: $PR_NUMBER"
          echo "  PR Head SHA: $PR_HEAD_SHA"
          echo "  Args: $CUSTOM_ARGS"
          echo ""

      - name: Run test script
        id: test-script
        working-directory: ./demo
        env:
          ENVIRONMENT_SECRET: ${{ secrets.ENVIRONMENT_SECRET }}
        run: |
          echo "üöÄ Running workflow test script..."
          echo ""

          # Run script with parsed arguments
          if [[ -n "$CUSTOM_ARGS" ]]; then
            ./generate-demo.sh --output output $CUSTOM_ARGS
          else
            ./generate-demo.sh --output output
          fi

      - name: Upload test results
        uses: actions/upload-artifact@v4
        with:
          name: workflow-test-pr-${{ env.PR_NUMBER }}
          path: demo/output/
          retention-days: 7

      - name: Create success status check
        if: success()
        uses: actions/github-script@v6
        with:
          script: |
            const customArgs = process.env.CUSTOM_ARGS || '(none)';
            await github.rest.repos.createCommitStatus({
              owner: context.repo.owner,
              repo: context.repo.repo,
              sha: '${{ env.PR_HEAD_SHA }}',
              state: 'success',
              context: 'Preview Demo Test',
              description: `‚úÖ Test completed with args: ${customArgs}`,
              target_url: `https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}`
            });

      - name: Create failure status check
        if: failure()
        uses: actions/github-script@v6
        with:
          script: |
            await github.rest.repos.createCommitStatus({
              owner: context.repo.owner,
              repo: context.repo.repo,
              sha: '${{ env.PR_HEAD_SHA }}',
              state: 'failure',
              context: 'Preview Demo Test',
              description: '‚ùå Test failed - check logs',
              target_url: `https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}`
            });

      - name: Comment results
        uses: actions/github-script@v6
        with:
          script: |
            const prNumber = ${{ env.PR_NUMBER }};
            const customArgs = process.env.CUSTOM_ARGS || '(none)';
            const runUrl = `https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}`;

            let body = `## üîß Workflow Test Completed\n\n`;
            body += `**Status:** ‚úÖ All mechanisms working\n`;
            body += `**PR:** #${prNumber}\n`;
            body += `**Arguments:** \`${customArgs}\`\n`;
            body += `**Logs:** [View details](${runUrl})\n`;
            body += `**Artifacts:** [Download test results](${runUrl})\n\n`;
            body += `This test verified:\n`;
            body += `- ‚úÖ Comment parsing and argument extraction\n`;
            body += `- ‚úÖ User permission validation\n`;
            body += `- ‚úÖ Environment secret access\n`;
            body += `- ‚úÖ Job dependencies and outputs\n`;
            body += `- ‚úÖ Artifact generation and upload\n`;
            body += `- ‚úÖ PR status check integration`;

            await github.rest.issues.createComment({
              issue_number: prNumber,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });

  cleanup:
    name: "Test Cleanup"
    runs-on: ubuntu-latest
    if: |
      (github.event_name == 'pull_request' && github.event.action == 'closed') ||
      (needs.security-check.outputs.cleanup_only == 'true')
    needs: [security-check]
    environment: preview-pr

    steps:
      - name: Simulate cleanup
        run: |
          pr_num="${{ github.event.number || needs.security-check.outputs.pr_number }}"
          echo "üßπ Testing cleanup for PR #${pr_num}"
          echo "   Would clean up resources here"
          echo "‚úÖ Cleanup test completed"

      - name: Comment cleanup
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v6
        with:
          script: |
            const prNumber = ${{ github.event.number }};
            const body = `## üßπ Cleanup Test\n\nTested automatic cleanup for PR #${prNumber}`;

            await github.rest.issues.createComment({
              issue_number: prNumber,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: body
            });

  manual-test:
    name: "Manual Test"
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch'
    environment: preview-pr

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Run manual test
        working-directory: ./demo
        run: |
          echo "üéÆ Manual workflow test"
          echo "PR: ${{ github.event.inputs.pr_number || 'manual' }}"
          echo "Args: ${{ github.event.inputs.custom_args || 'none' }}"
          echo ""

          args="${{ github.event.inputs.custom_args }}"
          if [[ -n "$args" ]]; then
            ./generate-demo.sh --output output $args
          else
            ./generate-demo.sh --output output --test
          fi

      - name: Upload manual test results
        uses: actions/upload-artifact@v4
        with:
          name: manual-test-${{ github.event.inputs.pr_number || 'manual' }}
          path: demo/output/
          retention-days: 7